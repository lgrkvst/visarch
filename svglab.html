<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Force based label placement</title>
		<script type='text/javascript' src='js/lib/d3.min.bm-w.cornerradius.js'></script>
		<script type='text/javascript' src='js/lib/jquery-1.10.2.min.js'></script>
	</head>
	<body>
		<div class="container-fluid">
			<div class="row-fluid">
				<div class="span12">
					<script type="text/javascript" charset="utf-8">
						var w = $(window).width(),
							h = $(window).height();
							
						var svg = d3.select("body").append("svg").attr("id","observatory").attr("width", w).attr("height", h);
						
						var n = {}, n1 = {}, n2 = {}, mean = {};
						n1.x = 541; n1.y = 134;
						n2.x = 504; n2.y = 212;
						n.x = 540; n.y = 188;
						
						svg.append("circle").attr("r", "4").attr("cx", n1.x).attr("cy", n1.y);
						svg.append("circle").attr("r", "4").attr("cx", n2.x).attr("cy", n2.y);
						var node = svg.append("g").attr("transform", function () {
							return "translate("+n.x+","+n.y+")"
						})
						node.append("circle").attr("r", "4");
						var new_label = node.append("text").text("new").attr("dy", ".35em").attr("dx", "10");
//						var old_label = node.append("text").text("old").attr("dy", ".35em").attr("dx", "10");
						
						mean.x = d3.mean([n1.x, n2.x]);
						mean.y = d3.mean([n1.y, n2.y]);
						
//						svg.append("circle").attr("r", "4").attr("cx", mean.x).attr("cy", mean.y).attr("fill", "#b9c");
//						old_label.attr("transform", "rotate("+57*myAtan(n.y-mean.y, n.x-mean.x)+")")

/* if we define dx=x2-x1 and dy=y2-y1, then the normals are (-dy, dx) and (dy, -dx). */
							
						var n_n1_x=n.x-n1.x;
						var n_n1_y=n.y-n1.y;

						var n_n2_x=n.x-n2.x;
						var n_n2_y=n.y-n2.y;

						svg.append("path").attr("d", "M"+n.x+","+n.y+"L"+(n1.x)+","+n1.y).style("stroke", "#000");
						svg.append("path").attr("d", "M"+n.x+","+n.y+"L"+(n2.x)+","+n2.y).style("stroke", "#000");
						svg.append("path").attr("d", "M"+n1.x+","+n1.y+"l"+(-n_n1_y)+","+n_n1_x).style("stroke", "#00f");
						svg.append("path").attr("d", "M"+n2.x+","+n2.y+"l"+(-n_n2_y)+","+n_n2_x).style("stroke", "#00f");
						var n_ns_x = (n_n1_x+n_n2_x)/2
						var n_ns_y = (n_n1_y+n_n2_y)/2

						svg.append("path").attr("d", "M"+n.x+","+n.y+"l"+n_ns_x+","+n_ns_y).style("stroke", "#f00");


						new_label.attr("transform", "rotate("+57*myAtan(n_ns_x, -n_ns_y)+")")


function myAtan(y, x) { // http://dspguru.com/dsp/tricks/fixed-point-atan2-with-self-normalization
	var coeff_1 = Math.PI / 4;
	var coeff_2 = 3 * coeff_1;
	var abs_y = y > 0 ? y : -y;
	var angle, r;
	if (x >= 0) {
		r = (x - abs_y) / (x + abs_y);
		angle = coeff_1 - coeff_1 * r;
	} else {
		r = (x + abs_y) / (abs_y - x);
		angle = coeff_2 - coeff_1 * r;
	}
	return y < 0 ? -angle : angle;
}




					</script>
	</body>

</html>